#!/bin/bash
# Squelch Security Status Dashboard

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}=== Squelch Security Status Dashboard ===${NC}"
echo "Generated: $(date)"
echo

# System info
echo -e "${BLUE}💻 SYSTEM INFO:${NC}"
echo "  Hostname: $(hostname)"
echo "  Uptime: $(uptime -p)"
echo "  Load: $(cat /proc/loadavg | cut -d' ' -f1-3)"
echo "  Memory: $(free -h | grep '^Mem:' | awk '{print $3 "/" $2}')"
echo

# fail2ban status
echo -e "${BLUE}🔒 FAIL2BAN STATUS:${NC}"
if systemctl is-active --quiet fail2ban; then
    echo -e "  Status: ${GREEN}Running${NC}"
    fail2ban-client status | sed 's/^/  /'
    echo

    # Jail details
    echo -e "${BLUE}📊 JAIL DETAILS:${NC}"
    for jail in $(fail2ban-client status | grep "Jail list:" | cut -d: -f2 | tr ',' ' '); do
        jail=$(echo $jail | xargs)
        if [ ! -z "$jail" ]; then
            echo "  --- $jail ---"
            fail2ban-client status $jail | grep -E "(Currently|Total)" | sed 's/^/    /'
        fi
    done
else
    echo -e "  Status: ${RED}Not Running${NC}"
fi
echo

# SSH security
echo -e "${BLUE}🔐 SSH SECURITY:${NC}"
if systemctl is-active --quiet ssh; then
    echo -e "  SSH Service: ${GREEN}Running${NC}"
    ssh_port=$(ss -tlnp | grep sshd | grep -o ':[0-9]*' | head -1 | cut -d: -f2)
    echo "  SSH Port: $ssh_port"

    # Check SSH config
    if sshd -T | grep -q "permitrootlogin no"; then
        echo -e "  Root Login: ${GREEN}Disabled${NC}"
    else
        echo -e "  Root Login: ${YELLOW}Enabled${NC}"
    fi

    if sshd -T | grep -q "passwordauthentication no"; then
        echo -e "  Password Auth: ${GREEN}Disabled${NC}"
    else
        echo -e "  Password Auth: ${YELLOW}Enabled${NC}"
    fi
else
    echo -e "  SSH Service: ${RED}Not Running${NC}"
fi
echo

# Recent activity
echo -e "${BLUE}📈 RECENT ACTIVITY (last 1h):${NC}"
echo "  SSH Connections:"
journalctl -u ssh --since "1 hour ago" | grep -E "(Accepted|Failed)" | tail -5 | sed 's/^/    /' || echo "    No recent SSH activity"
echo

echo "  fail2ban Activity:"
journalctl -u fail2ban --since "1 hour ago" | grep -E "(Ban|Found)" | tail -5 | sed 's/^/    /' || echo "    No recent fail2ban activity"
echo

# Network connections
echo -e "${BLUE}🌐 ACTIVE CONNECTIONS:${NC}"
echo "  Listening Ports:"
ss -tlnp | grep LISTEN | awk '{print "    " $1 " " $4}' | sort
echo

# Top IPs from logs
echo -e "${BLUE}📊 TOP IPs (if logs available):${NC}"
if [ -f /var/log/caddy/access.log ]; then
    echo "  Caddy Access Log:"
    grep '"remote_ip"' /var/log/caddy/access.log 2>/dev/null | grep -o '"remote_ip":"[^"]*"' | cut -d'"' -f4 | sort | uniq -c | sort -nr | head -5 | sed 's/^/    /' || echo "    No data"
elif [ -f /var/log/nginx/access.log ]; then
    echo "  Nginx Access Log:"
    awk '{print $1}' /var/log/nginx/access.log 2>/dev/null | sort | uniq -c | sort -nr | head -5 | sed 's/^/    /' || echo "    No data"
else
    echo "    No web server logs found"
fi
echo

echo -e "${GREEN}✅ Security monitoring active${NC}"